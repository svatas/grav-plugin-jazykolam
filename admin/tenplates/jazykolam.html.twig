{% extends 'partials/base.html.twig' %}

{% block title %}Jazykolam – Translation Manager{% endblock %}

{% block content %}
<h1>Jazykolam – Translation Manager</h1>

<p>
  Nástroj pro správu překladových klíčů: úprava hodnot, doplnění chybějících překladů,
  přidávání nových klíčů a náhled klíčů detekovaných v Twig šablonách.
</p>

<div class="block">
  <label>
    <strong>Filtr:</strong>
    <input type="text" id="jazykolam-filter" placeholder="Hledat v klíčích nebo textech…" style="min-width:260px;" />
  </label>
  <label style="margin-left:1rem;">
    <input type="checkbox" id="jazykolam-missing-only" />
    Pouze klíče s chybějícím překladem
  </label>
</div>

<form method="post" action="{{ uri.addNonce(url('task', 'jazykolam.saveTranslations'), 'admin-form', 'admin-nonce') }}">
  <table class="grav-table" id="jazykolam-table">
    <thead>
      <tr>
        <th>Key</th>
        {% for lang in jazykolam_languages %}
          <th>{{ lang|upper }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% set missing_set = jazykolam_missing_keys|default([])|array_flip %}
      {% for key, langs in jazykolam_translations %}
        {% set is_missing = key in missing_set %}
        <tr class="jaz-row{% if is_missing %} is-missing{% endif %}"
            data-key="{{ key }}"
            data-missing="{{ is_missing ? '1' : '0' }}">
          <td><code>{{ key }}</code></td>
          {% for lang in jazykolam_languages %}
            {% set val = langs[lang]|default('') %}
            <td>
              <input type="text"
                     name="jazykolam[{{ key }}][{{ lang }}]"
                     value="{{ val|e('html_attr') }}"
                     style="width:100%;"
                     {% if val == '' %}placeholder="(missing)"{% endif %}/>
            </td>
          {% endfor %}
        </tr>
      {% endfor %}

      <tr class="jaz-new">
        <td>
          <input type="text"
                 name="jazykolam_new_key"
                 placeholder="NEW.KEY"
                 style="width:100%; font-weight:bold;" />
        </td>
        {% for lang in jazykolam_languages %}
          <td>
            <input type="text"
                   name="jazykolam_new[{{ lang }}]"
                   placeholder="{{ lang|upper }} value"
                   style="width:100%;" />
          </td>
        {% endfor %}
      </tr>
    </tbody>
  </table>

  <div class="button-bar">
    <button class="button primary" type="submit">
      <i class="fa fa-save"></i> {{ 'PLUGIN_ADMIN.SAVE'|tu }}
    </button>
  </div>

  <input type="hidden" name="task" value="jazykolam.saveTranslations" />
</form>

<p class="notice">
  Překlady se ukládají do <code>user/languages.jazykolam.yaml</code> (s automatickou zálohou `.bak` před uložením).
  Hodnoty z tohoto souboru mají prioritu před ostatními zdroji.
</p>

<script>
(function(){
  var input = document.getElementById('jazykolam-filter');
  var missingOnly = document.getElementById('jazykolam-missing-only');
  var table = document.getElementById('jazykolam-table');
  if(!input || !table) return;

  function norm(s){ return (s || '').toString().toLowerCase(); }

  function apply(){
    var q = norm(input.value);
    var miss = !!missingOnly.checked;
    var rows = table.querySelectorAll('tbody tr.jaz-row');
    rows.forEach(function(tr){
      var key = norm(tr.getAttribute('data-key'));
      var isMissing = tr.getAttribute('data-missing') === '1';
      var text = key;
      tr.querySelectorAll('input[type="text"]').forEach(function(inp){
        text += ' ' + norm(inp.value);
      });
      var match = !q || text.indexOf(q) !== -1;
      var missOk = !miss || isMissing;
      tr.style.display = (match && missOk) ? '' : 'none';
    });
  }

  input.addEventListener('input', apply);
  missingOnly.addEventListener('change', apply);
})();
</script>
{% endblock %}
