{% extends 'partials/base.html.twig' %}

{% block title %}Jazykolam – Translation Manager{% endblock %}

{% block content %}
<h1>Jazykolam – Translation Manager</h1>

<p>
  Tento nástroj umožňuje spravovat překladové klíče použitím Jazykolamu –
  upravovat hodnoty, doplňovat chybějící překlady a přidávat nové klíče,
  aniž by bylo nutné ručně editovat YAML soubory.
</p>

<div class="block">
  <label>
    <strong>Filtr:</strong>
    <input type="text" id="jazykolam-filter" placeholder="Hledat v klíčích nebo textech…" style="min-width:260px;" />
  </label>
  <label style="margin-left:1rem;">
    <input type="checkbox" id="jazykolam-missing-only" />
    Pouze klíče s chybějícím překladem
  </label>
</div>

<form method="post" action="{{ uri.addNonce(url('task', 'jazykolam.saveTranslations'), 'admin-form', 'admin-nonce') }}">
  <table class="grav-table" id="jazykolam-table">
    <thead>
      <tr>
        <th>Key</th>
        {% for lang in jazykolam_languages %}
          <th>{{ lang|upper }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% set missing_set = jazykolam_missing_keys|default([])|array_flip %}
      {% for key, langs in jazykolam_translations %}
        {% set is_missing = key in missing_set %}
        <tr class="jaz-row{% if is_missing %} is-missing{% endif %}"
            data-key="{{ key }}"
            data-missing="{{ is_missing ? '1' : '0' }}">
          <td>
            <code>{{ key }}</code>
          </td>
          {% for lang in jazykolam_languages %}
            {% set val = langs[lang]|default('') %}
            <td>
              <input type="text"
                     name="jazykolam[{{ key }}][{{ lang }}]"
                     value="{{ val|e('html_attr') }}"
                     style="width:100%;"
                     {% if val == '' %}placeholder="(missing)"{% endif %}/>
            </td>
          {% endfor %}
        </tr>
      {% endfor %}

      {# New key row #}
      <tr class="jaz-new">
        <td>
          <input type="text"
                 name="jazykolam_new_key"
                 placeholder="NEW.KEY"
                 style="width:100%; font-weight:bold;" />
        </td>
        {% for lang in jazykolam_languages %}
          <td>
            <input type="text"
                   name="jazykolam_new[{{ lang }}]"
                   placeholder="{{ lang|upper }} value"
                   style="width:100%;" />
          </td>
        {% endfor %}
      </tr>
    </tbody>
  </table>

  <div class="button-bar">
    <button class="button primary" type="submit">
      <i class="fa fa-save"></i> {{ 'PLUGIN_ADMIN.SAVE'|tu }}
    </button>
  </div>

  <input type="hidden" name="task" value="jazykolam.saveTranslations" />
</form>

<p class="notice">
  Překlady se ukládají do <code>user/languages.jazykolam.yaml</code>.
  Tento soubor má vyšší prioritu než ostatní zdroje překladů.
  Před uložením změn je vytvořena záloha s časovým razítkem.
</p>

<script>
(function(){
  var input = document.getElementById('jazykolam-filter');
  var missingOnly = document.getElementById('jazykolam-missing-only');
  var table = document.getElementById('jazykolam-table');
  if(!input || !table) return;

  function normalize(s){
    return (s || '').toString().toLowerCase();
  }

  function applyFilter(){
    var q = normalize(input.value);
    var missing = !!missingOnly.checked;
    var rows = table.querySelectorAll('tbody tr.jaz-row');
    rows.forEach(function(tr){
      var key = normalize(tr.getAttribute('data-key'));
      var isMissing = tr.getAttribute('data-missing') === '1';
      var text = key;

      // include cell values
      tr.querySelectorAll('input[type="text"]').forEach(function(inp){
        text += ' ' + normalize(inp.value);
      });

      var match = !q || text.indexOf(q) !== -1;
      var missOk = !missing || isMissing;
      tr.style.display = (match && missOk) ? '' : 'none';
    });
  }

  input.addEventListener('input', applyFilter);
  missingOnly.addEventListener('change', applyFilter);
})();
</script>
{% endblock %}
